<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MercaPlan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/style.css">
</head>

<body>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .navbar {
            box-shadow: 0 4px 6px rgba(58, 61, 58, 0.1);
        }

        .banner {
            background: linear-gradient(rgba(66, 255, 75, 0.5), rgba(67, 184, 0, 0.5)),
                url('https://via.placeholder.com/1200x400') no-repeat center center/cover;
            padding: 80px 20px;
            text-align: center;
            color: #fff;
            border-radius: 0 0 20px 20px;
        }

        .banner h1 {
            font-size: 3rem;
            font-weight: bold;
        }

        .card {
            border: none;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        .placeholder-img {
            background-color: #e0e0e0;
            height: 200px;
        }

        .card-title {
            color: #28a745;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .footer {
            background-color: #198754;
            color: white;
            padding: 20px 0;
            margin-top: 50px;
        }
    </style>

    <nav class="navbar navbar-expand-lg navbar-dark bg-success sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">MercaPlan</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <form id="formBuscar" class="d-flex ms-auto me-3">
                    <input id="inputBuscar" class="form-control me-2" type="search" placeholder="Busca un producto" />
                    <button class="btn btn-light" type="submit">Buscar</button>
                </form>
                <span id="total-carrito" class="text-white me-3 fw-bold m-4">$0</span>
                <button class="btn btn-outline-light">Carrito</button>
                <!-- Botón de login -->
                <button class="btn btn-outline-light m-3" id="btnLogin">Login</button>
                <!-- Botón de logout oculto al principio -->
                <button class="btn btn-danger m-3 d-none" id="btnLogout">Cerrar sesión</button>
            </div>
        </div>
    </nav>

    <div class="banner">
        <h1>MercaPlan</h1>
        <p>Planifica tus compras de forma inteligente y eficiente</p>
    </div>

    <div class="container py-5">
        <div class="row g-4">
            <!-- Aquí se cargan dinámicamente los productos -->
        </div>
    </div>

    <div class="footer text-center">
        <p>&copy; 2025 MercaPlan - Todos los derechos reservados.</p>
    </div>

    <!-- Script de funcionalidad -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const productosContainer = document.querySelector('.row.g-4');
            const formBuscar = document.getElementById('formBuscar');
            const inputBuscar = document.getElementById('inputBuscar');
            const btnCarrito = document.querySelectorAll('.btn.btn-outline-light')[0]; // primer botón "Carrito"
            const btnLogin = document.querySelector('.btn.btn-outline-light.m-3');
            const totalSpan = document.getElementById('total-carrito');
            const RADIO_KM = 0.5;

            let productos = [];
            let carrito = [];
            let userLat = null;
            let userLng = null;

            function calcularDistancia(lat1, lng1, lat2, lng2) {
                const toRad = deg => deg * Math.PI / 180;
                const R = 6371;
                const dLat = toRad(lat2 - lat1);
                const dLng = toRad(lng2 - lng1);
                const a = Math.sin(dLat / 2) ** 2 +
                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                    Math.sin(dLng / 2) ** 2;
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }

            function renderProductos(lista) {
                productosContainer.innerHTML = '';
                if (lista.length === 0) {
                    productosContainer.innerHTML = '<p class="text-center">No hay productos cercanos.</p>';
                    return;
                }

                lista.forEach(p => {
                    const col = document.createElement('div');
                    col.className = 'col-6 col-md-4 col-lg-3';

                    const distanciaTexto = p.distancia !== Infinity
                        ? `${p.distancia.toFixed(2)} km`
                        : 'Distancia desconocida';

                    col.innerHTML = `
                    <div class="card">
                        <img src="${p.imagen}" alt="${p.nombre}" class="card-img-top" style="height: 200px; object-fit: cover;">
                        <div class="card-body text-center">
                            <h5 class="card-title">${p.nombre}</h5>
                            <p class="card-text">${p.tienda} - <small>${distanciaTexto}</small></p>
                            <h6 class="text-success">$${p.precio.toLocaleString('es-CL')}</h6>
                            <a href="${p.url}" target="_blank" class="btn btn-success w-100 mb-2">Cómo llegar</a>
                            <button class="btn btn-outline-success w-100 agregar-carrito">Agregar al carrito</button>
                        </div>
                    </div>
                    `;
                    productosContainer.appendChild(col);
                });
            }

            function actualizarTotal() {
                const total = carrito.reduce((sum, p) => sum + p.precio, 0);
                totalSpan.textContent = '$' + total.toLocaleString('es-CL');
            }

            // Nueva versión de filtrarYMostrar que recibe término de búsqueda
            function filtrarYMostrar(termino = '') {
                let lista = productos.map(p => {
                    if (userLat !== null && userLng !== null) {
                        p.distancia = calcularDistancia(userLat, userLng, p.lat, p.lng);
                    } else {
                        p.distancia = Infinity;
                    }
                    return p;
                });

                // Filtrar por radio de distancia
                lista = lista.filter(p => p.distancia <= RADIO_KM);

                // Filtrar por término de búsqueda si existe
                if (termino) {
                    lista = lista.filter(p => p.nombre.toLowerCase().includes(termino));
                }

                // Ordenar por distancia
                lista.sort((a, b) => a.distancia - b.distancia);

                renderProductos(lista);
            }

            async function cargarProductos() {
                try {
                    const response = await fetch('static/data/productos.json');
                    productos = await response.json();
                    filtrarYMostrar(); // carga inicial sin filtro
                } catch (error) {
                    console.error('Error al cargar productos:', error);
                }
            }

            function obtenerUbicacion() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        pos => {
                            userLat = pos.coords.latitude;
                            userLng = pos.coords.longitude;
                            filtrarYMostrar();
                        },
                        err => {
                            console.warn('Ubicación no disponible:', err.message);
                            filtrarYMostrar();
                        }
                    );
                } else {
                    console.warn('Geolocalización no soportada');
                    filtrarYMostrar();
                }
            }

            productosContainer.addEventListener('click', e => {
                if (e.target.classList.contains('agregar-carrito')) {
                    const card = e.target.closest('.card');
                    const nombre = card.querySelector('.card-title').textContent;
                    const precioTexto = card.querySelector('.text-success').textContent.replace(/[^\d]/g, '');
                    const precio = parseInt(precioTexto);

                    const producto = { nombre, precio };
                    carrito.push(producto);
                    actualizarTotal();
                    alert(`"${nombre}" se agregó al carrito.`);
                }
            });

            btnCarrito.addEventListener('click', () => {
                if (carrito.length === 0) {
                    alert('El carrito está vacío.');
                    return;
                }

                const resumen = carrito.map(p => `- ${p.nombre} ($${p.precio.toLocaleString('es-CL')})`).join('\n');
                const total = carrito.reduce((sum, p) => sum + p.precio, 0);
                alert(`🛒 Productos en el carrito:\n\n${resumen}\n\nTotal: $${total.toLocaleString('es-CL')}`);
            });

            btnLogin.addEventListener('click', () => {
                const user = prompt('Ingresa tu nombre de usuario:');
                if (user) {
                    alert(`Bienvenido, ${user}`);
                    btnLogin.textContent = user;
                }
            });

            // Listener solo para el submit del formulario de búsqueda
            formBuscar.addEventListener('submit', e => {
                e.preventDefault();
                const termino = inputBuscar.value.trim().toLowerCase();

                if (!termino) {
                    alert('Por favor, ingresa un término para buscar.');
                    return;
                }

                filtrarYMostrar(termino);
            });

            // No hay listener para inputBuscar 'input', solo busca al enviar formulario

            cargarProductos();
            obtenerUbicacion();
        });
    </script>

    <script src="static/js/app.js"></script>
</body>


</html>